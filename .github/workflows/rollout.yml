# This is a basic workflow to help you get started with Actions
name: Phased rollout to environments and regions

# Controls when the workflow will run
on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      release:
        description: "Octopus Release Number"
        required: true

env:
  OCTOPUS_URL: https://demo.octopus.app
  OCTOPUS_SERVICE_ACCOUNT: 4d50c8ac-1515-4351-96a7-4a82d55d55ff
  OCTOPUS_SPACE: "Deep Ellum Tech"
  OCTOPUS_PROJECT: "ACH Router"

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  deploy-to-development-alpha:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    name: "ğŸ™ Deploy release ${{ github.event.inputs.release }} to Development - Alpha regions"
    outputs:
      server_tasks: ${{ steps.deploy-release-to-alpha.outputs.server_tasks }}
    permissions:
      id-token: write

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - name: ğŸ™ Login to Octopus Deploy
        uses: OctopusDeploy/login@v1
        with:
          server: ${{ env.OCTOPUS_URL }}
          service_account_id: ${{ env.OCTOPUS_SERVICE_ACCOUNT }}
      - uses: OctopusDeploy/deploy-release-tenanted-action@v3
        id: "deploy-release-to-alpha"
        name: "ğŸ™ Deploy release ${{ github.event.inputs.release }} to  Development - Alpha regions"
        with:
          project: ${{ env.OCTOPUS_PROJECT }}
          release_number: ${{ github.event.inputs.release }}
          environment: "Development"
          tenant_tags: "Release Ring/Alpha"
      - id: "print-tasks"
        run: echo "${{ steps.deploy-release-to-alpha.outputs.server_tasks }}"

  wait-for-development-alpha:
    needs: [ deploy-to-development-alpha ]
    runs-on: ubuntu-latest
    name: "ğŸ™ Wait for deployment of ${{ github.event.inputs.release }} to  Development - Alpha regions to complete"
    strategy:
      matrix:
        value: ${{ fromJson(needs.deploy-to-development-alpha.outputs.server_tasks) }}
    permissions:
      id-token: write
  
    steps:
      - name: ğŸ™ Login to Octopus Deploy
        uses: OctopusDeploy/login@v1
        with:
          server: ${{ env.OCTOPUS_URL }}
          service_account_id: ${{ env.OCTOPUS_SERVICE_ACCOUNT }}
      - uses: OctopusDeploy/await-task-action@v3
        id: "wait-for-deploy-alpha"
        name: "ğŸ™ Wait for deployment of ${{ github.event.inputs.release }} to ${{ matrix.value.tenantName }} to complete"
        with:
          server_task_id: ${{ matrix.value.serverTaskId }}

### TEST ###
  deploy-to-test-alpha:
    needs: [ wait-for-development-alpha ]
    runs-on: ubuntu-latest
    name: "ğŸ™ Deploy release ${{ github.event.inputs.release }} to Test - Alpha regions"
    outputs:
      server_tasks: ${{ steps.deploy-release-to-alpha.outputs.server_tasks }}
    permissions:
      id-token: write

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - name: ğŸ™ Login to Octopus Deploy
        uses: OctopusDeploy/login@v1
        with:
          server: ${{ env.OCTOPUS_URL }}
          service_account_id: ${{ env.OCTOPUS_SERVICE_ACCOUNT }}
      - uses: OctopusDeploy/deploy-release-tenanted-action@v3
        id: "deploy-release-to-alpha"
        name: "ğŸ™ Deploy release ${{ github.event.inputs.release }} to  Test - Alpha regions"
        with:
          project: ${{ env.OCTOPUS_PROJECT }}
          release_number: ${{ github.event.inputs.release }}
          environment: "Test"
          tenant_tags: "Release Ring/Alpha"
      - id: "print-tasks"
        run: echo "${{ steps.deploy-release-to-alpha.outputs.server_tasks }}"

  wait-for-test-alpha:
    needs: [ deploy-to-test-alpha ]
    runs-on: ubuntu-latest
    name: "ğŸ™ Wait for deployment of ${{ github.event.inputs.release }} to  Test - Alpha regions to complete"
    strategy:
      matrix:
        value: ${{ fromJson(needs.deploy-to-test-alpha.outputs.server_tasks) }}
    permissions:
      id-token: write
  
    steps:
      - name: ğŸ™ Login to Octopus Deploy
        uses: OctopusDeploy/login@v1
        with:
          server: ${{ env.OCTOPUS_URL }}
          service_account_id: ${{ env.OCTOPUS_SERVICE_ACCOUNT }}
      - uses: OctopusDeploy/await-task-action@v3
        id: "wait-for-deploy-alpha"
        name: "ğŸ™ Wait for deployment of ${{ github.event.inputs.release }} to ${{ matrix.value.tenantName }} to complete"
        with:
          server_task_id: ${{ matrix.value.serverTaskId }}

  deploy-to-test-beta:
    needs: [ wait-for-test-alpha ]
    runs-on: ubuntu-latest
    name: "ğŸ™ Deploy release ${{ github.event.inputs.release }} to Test - Alpha regions"
    outputs:
      server_tasks: ${{ steps.deploy-release-to-alpha.outputs.server_tasks }}
    permissions:
      id-token: write

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - name: ğŸ™ Login to Octopus Deploy
        uses: OctopusDeploy/login@v1
        with:
          server: ${{ env.OCTOPUS_URL }}
          service_account_id: ${{ env.OCTOPUS_SERVICE_ACCOUNT }}
      - uses: OctopusDeploy/deploy-release-tenanted-action@v3
        id: "deploy-release-to-alpha"
        name: "ğŸ™ Deploy release ${{ github.event.inputs.release }} to  Test - Beta regions"
        with:
          project: ${{ env.OCTOPUS_PROJECT }}
          release_number: ${{ github.event.inputs.release }}
          environment: "Test"
          tenant_tags: "Release Ring/Beta"
      - id: "print-tasks"
        run: echo "${{ steps.deploy-release-to-alpha.outputs.server_tasks }}"

  wait-for-test-beta:
    needs: [ deploy-to-test-beta ]
    runs-on: ubuntu-latest
    name: "ğŸ™ Wait for deployment of ${{ github.event.inputs.release }} to  Test - Beta regions to complete"
    strategy:
      matrix:
        value: ${{ fromJson(needs.deploy-to-test-beta.outputs.server_tasks) }}
    permissions:
      id-token: write
  
    steps:
      - name: ğŸ™ Login to Octopus Deploy
        uses: OctopusDeploy/login@v1
        with:
          server: ${{ env.OCTOPUS_URL }}
          service_account_id: ${{ env.OCTOPUS_SERVICE_ACCOUNT }}
      - uses: OctopusDeploy/await-task-action@v3
        id: "wait-for-deploy-alpha"
        name: "ğŸ™ Wait for deployment of ${{ github.event.inputs.release }} to ${{ matrix.value.tenantName }} to complete"
        with:
          server_task_id: ${{ matrix.value.serverTaskId }}

### PRODUCTION ###
  deploy-to-production-alpha:
    needs: [ wait-for-test-beta ]
    runs-on: ubuntu-latest
    name: "ğŸ™ Deploy release ${{ github.event.inputs.release }} to Production - Alpha regions"
    outputs:
      server_tasks: ${{ steps.deploy-release-to-alpha.outputs.server_tasks }}
    permissions:
      id-token: write

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - name: ğŸ™ Login to Octopus Deploy
        uses: OctopusDeploy/login@v1
        with:
          server: ${{ env.OCTOPUS_URL }}
          service_account_id: ${{ env.OCTOPUS_SERVICE_ACCOUNT }}
      - uses: OctopusDeploy/deploy-release-tenanted-action@v3
        id: "deploy-release-to-alpha"
        name: "ğŸ™ Deploy release ${{ github.event.inputs.release }} to  Production - Alpha regions"
        with:
          project: ${{ env.OCTOPUS_PROJECT }}
          release_number: ${{ github.event.inputs.release }}
          environment: "Production"
          tenant_tags: "Release Ring/Alpha"

  wait-for-production-alpha:
    needs: [ deploy-to-production-alpha ]
    runs-on: ubuntu-latest
    name: "ğŸ™ Wait for deployment of ${{ github.event.inputs.release }} to  Production - Alpha regions to complete"
    strategy:
      matrix:
        value: ${{ fromJson(needs.deploy-to-production-alpha.outputs.server_tasks) }}
    permissions:
      id-token: write
  
    steps:
      - name: ğŸ™ Login to Octopus Deploy
        uses: OctopusDeploy/login@v1
        with:
          server: ${{ env.OCTOPUS_URL }}
          service_account_id: ${{ env.OCTOPUS_SERVICE_ACCOUNT }}
      - uses: OctopusDeploy/await-task-action@v3
        id: "wait-for-deploy-alpha"
        name: "ğŸ™ Wait for deployment of ${{ github.event.inputs.release }} to ${{ matrix.value.tenantName }} to complete"
        with:
          server_task_id: ${{ matrix.value.serverTaskId }}

  approve-production-alpha-deployment:
    name: âœ… Approve Alpha deployment
    needs: [wait-for-production-alpha]
    runs-on: ubuntu-latest
    environment: 'alpha'
      
    steps:
      - name: Gather Alpha approval
        run: echo "âœ… Approval gathered"

  deploy-to-production-beta:
    # The type of runner that the job will run on
    needs: [approve-production-alpha-deployment]
    runs-on: ubuntu-latest
    name: "ğŸ™ Deploy release ${{ github.event.inputs.release }} to Production - Beta regions"
    outputs:
      server_tasks: ${{ steps.deploy-release-to-beta.outputs.server_tasks }}
    permissions:
      id-token: write

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - name: ğŸ™ Login to Octopus Deploy
        uses: OctopusDeploy/login@v1
        with:
          server: ${{ env.OCTOPUS_URL }}
          service_account_id: ${{ env.OCTOPUS_SERVICE_ACCOUNT }}
      - uses: OctopusDeploy/deploy-release-tenanted-action@v3
        id: "deploy-release-to-beta"
        name: "ğŸ™ Deploy release ${{ github.event.inputs.release }} to Production - Beta regions"
        with:
          project: ${{ env.OCTOPUS_PROJECT }}
          release_number: ${{ github.event.inputs.release }}
          environment: "Production"
          tenant_tags: "Release Ring/Beta"
      - id: "print-tasks"
        run: echo "${{ steps.deploy-release-to-beta.outputs.server_tasks }}"

  wait-for-production-beta:
    needs: [ deploy-to-production-beta ]
    runs-on: ubuntu-latest
    name: "ğŸ™ Wait for deployment of ${{ github.event.inputs.release }} to Production - Beta regions to complete"
    strategy:
      matrix:
        value: ${{ fromJson(needs.deploy-to-production-beta.outputs.server_tasks) }}
    permissions:
      id-token: write
  
    steps:
      - name: ğŸ™ Login to Octopus Deploy
        uses: OctopusDeploy/login@v1
        with:
          server: ${{ env.OCTOPUS_URL }}
          service_account_id: ${{ env.OCTOPUS_SERVICE_ACCOUNT }}
      - uses: OctopusDeploy/await-task-action@v3
        id: "wait-for-deploy-beta"
        name: "ğŸ™ Wait for deployment of ${{ github.event.inputs.release }} to ${{ matrix.value.tenantName }} to complete"
        with:
          server_task_id: ${{ matrix.value.serverTaskId }}

  approve-production-beta-deployment:
    name: âœ… Approve Beta deployment
    needs: [wait-for-production-beta]
    runs-on: ubuntu-latest
    environment: 'beta'
      
    steps:
      - name: Gather Beta approval
        run: echo "âœ… Approval gathered"

  deploy-to-production-stable:
    needs: [approve-production-beta-deployment]
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    name: "ğŸ™ Deploy release ${{ github.event.inputs.release }} to Production - Stable regions"
    outputs:
      server_tasks: ${{ steps.deploy-release-to-stable.outputs.server_tasks }}
    permissions:
      id-token: write

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - name: ğŸ™ Login to Octopus Deploy
        uses: OctopusDeploy/login@v1
        with:
          server: ${{ env.OCTOPUS_URL }}
          service_account_id: ${{ env.OCTOPUS_SERVICE_ACCOUNT }}
      - uses: OctopusDeploy/deploy-release-tenanted-action@v3
        id: "deploy-release-to-stable"
        name: "ğŸ™ Deploy release ${{ github.event.inputs.release }} to Production - Stable regions"
        with:
          project: ${{ env.OCTOPUS_PROJECT }}
          release_number: ${{ github.event.inputs.release }}
          environment: "Production"
          tenant_tags: "Release Ring/Stable"
      - id: "print-tasks"
        run: echo "${{ steps.deploy-release-to-stable.outputs.server_tasks }}"

  wait-for-stable:
    needs: [ deploy-to-production-stable ]
    runs-on: ubuntu-latest
    name: "ğŸ™ Wait for deployment of ${{ github.event.inputs.release }} to Production - Stable regions to complete"
    strategy:
      matrix:
        value: ${{ fromJson(needs.deploy-to-production-stable.outputs.server_tasks) }}
    permissions:
      id-token: write
  
    steps:
      - name: ğŸ™ Login to Octopus Deploy
        uses: OctopusDeploy/login@v1
        with:
          server: ${{ env.OCTOPUS_URL }}
          service_account_id: ${{ env.OCTOPUS_SERVICE_ACCOUNT }}
      - uses: OctopusDeploy/await-task-action@v3
        id: "wait-for-deploy-stable"
        name: "ğŸ™ Wait for deployment of ${{ github.event.inputs.release }} to ${{ matrix.value.tenantName }} to complete"
        with:
          server_task_id: ${{ matrix.value.serverTaskId }}
